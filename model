from google.colab import drive
drive.mount('/content/drive', force_remount=True)
from posix import listdir
import tensorflow as tf
import numpy as np
import pandas as pd
import cv2
from google.colab.patches import cv2_imshow
from sklearn.model_selection import train_test_split
import os
from os.path import isfile, isdir, join
from keras.models import Sequential
from keras.layers import Conv2D, MaxPooling2D, AveragePooling2D, Dense, Activation, Flatten

targetpath = ["/content/drive/MyDrive/fray_colab_dataset/mika/train"
        ,"/content/drive/MyDrive/fray_colab_dataset/mika/vaild"
        ,"/content/drive/MyDrive/fray_colab_dataset/mika/test"]

#define the basic setting
imglenth = 300
imgwidth = 300
num_of_traindata = 50
num_of_testdata = 30
label_size = 2

# Define the CNN model
model = Sequential()

# Convolutional and pooling layers
model.add(Conv2D(32, (3, 3), activation='relu', input_shape=(imglenth, imgwidth, 3)))
model.add(MaxPooling2D((2, 2)))

model.add(Conv2D(32, (3, 3), activation='relu'))
model.add(MaxPooling2D((2, 2)))

model.add(Conv2D(64, (3, 3), activation='relu'))
model.add(MaxPooling2D((2, 2)))

model.add(Conv2D(64, (3, 3), activation='relu'))
model.add(MaxPooling2D((2, 2)))

# Flatten layer to connect the convolutional layers to the fully connected layers
model.add(Flatten())

# Fully connected layers
model.add(Dense(128, activation='relu'))
model.add(Dense(label_size, activation='softmax'))  # Output layer with 10 units for classification

# Compile the model
model.compile(optimizer='adam',
              loss='categorical_crossentropy',
              metrics=['accuracy'])

# Display the model summary
model.summary()

#import the image
databox = [[],[],[]]
label = [[],[],[]]
ind = [0,0,0]

for j in range(0,3):
  file = listdir(targetpath[j])
  for i in file:
    fullpath = join(targetpath[j], i)
    if isfile(fullpath):
      databox[j].append(np.array(cv2.imread(fullpath)))
      label[j].append(np.array([1.0,0.0]))
      ind[j] = ind[j] + 1
    elif isdir(fullpath):
      print("error, this should be file")


for i in range(2,3):
  for j in range(0,ind[i]):
    print("this picture's name is: ")
    print(label[i][j])
  #cv2_imshow(databox[i])

#define the train data
train_data = np.array(databox[0])
train_labels = np.array(label[0])
val_data = np.array(databox[1])
val_labels = np.array(label[1])
test_data = np.array(databox[2])
test_labels = np.array(label[2])

model.fit(train_data, train_labels, batch_size=1, epochs=10, validation_data=(val_data, val_labels))
test_loss, test_acc = model.evaluate(test_data, test_labels)

print(f'Test accuracy: {test_acc}')
print(f'Test loss: {test_loss}')
